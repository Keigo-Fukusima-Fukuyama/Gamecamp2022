#define PLAYER_SPEED_X 10
#define PLAYER_SPEED_Y 10
#define PLAYER_SHOTTIME 10
#define PLAYER_COOLTIME_MAX 15 //大攻撃のクールタイム 仮
#define PLAYER_COOLTIME_MIN 5 //少攻撃のクールタイム 仮
#define PLAYER_HP_MAX 100 //仮

#include "CPlayer.h"
#include "CKey.h"
#include"CTaskManager.h"
#include "CBullet.h"

//extern：他のソースファイルの外部変数にアクセスする宣言
extern CTexture Texture;

CPlayer::CPlayer()
: mFx(1.0f), mFy(0.0f)
, FireCount(0)
{
	 x = -900;
	 y = -270;
	 w = 25;
	 h = 25;
	 mHp = PLAYER_HP_MAX;
	mTag = EPLAYER;
}

void CPlayer::Update() {

	//staticメソッドはどこからでも呼べる
	if (CKey::Push('A')) {
		
		x -= PLAYER_SPEED_X;
		mFx = -1;
		mFy = 0;
		if (x - w < -960) {
			x = -960 + w;
		}
	}
	if (CKey::Push('D')) {
		x += PLAYER_SPEED_X;
		mFx = 1;
		mFy = 0;
		if (x + w > 960) {
			x = 960 - w;
		}
	}
	if (CKey::Push('W')) {
		y += PLAYER_SPEED_Y;
		mFx = 0;
		mFy = 1;
		if (y + h > 0) {
			y = 0 - h;
		}
	}
	if (CKey::Push('S')) {
		y -= PLAYER_SPEED_Y;
		mFx = 0;
		mFy = -1;
		if (y - h < -515) {
			y = -515 + h;
		}
	}
	//37
	//スペースキーで弾発射
	//0より大きいとき1減算する
	if (FireCount > 0) {
		FireCount--;
	}
	//FireContが0で、かつ、スペースキーで弾発射
	else if( CKey::Once(' ')) {
		CBullet *Bullet = new CBullet();
		//発射位置の設定
		Bullet->x = x;
		Bullet->y = y;
		//移動の値を設定
		Bullet->mFx = mFx * 5;
		Bullet->mFy = mFy * 5;
		//有効にする
		Bullet->mEnabled = true;
		//プレイヤーの弾を設定
		Bullet->mTag =EPLAYERBULLET;
		FireCount = PLAYER_SHOTTIME;
	}
	//37
}

void CPlayer::Render() {
	CRectangle::Render(Texture, 146 - 16, 146 + 16, 146 + 16, 146 - 16);
}


//36
void CPlayer::Collision(CRectangle *ri, CRectangle *ry) //ブロックにぶつかったとき
{
	if (ry->mTag == EBLOCK) {
		int mx, my;
		if (CRectangle::Collision(ry, &mx, &my)) {
			//abs(x) xの絶対値を求める
			//移動量が少ない方向だけ移動させる
			if (abs(mx) < abs(my)) {
				//Rectをxだけ移動する
				x += mx;
			}
			else {
				//Rectをyだけ移動する
				y += my;
			}
		}
	}
}
void CPlayer::Collision(const CRectangle& r) //攻撃されたとき
{
	if (CRectangle::Collision(r)) {
		switch (r.mTag) {

		case EENEMYBULLET:
			//エネミーの弾に当たると、HPが10減る
			mHp -= 10;
			break;
		}
	}
}
